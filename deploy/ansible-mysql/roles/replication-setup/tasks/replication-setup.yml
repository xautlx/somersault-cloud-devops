### value of mode must be one of: getprimary, getreplica, changeprimary, stopreplica, startreplica, resetprimary, resetreplica, resetreplicaall
---
- name: Get replication master addr from hosts config
  set_fact:
    mysql_replication_master: "{{hostvars[item]['ansible_ssh_host']}}"
  when: hostvars[inventory_hostname]['ansible_ssh_host'] != hostvars[item]['ansible_ssh_host']
  with_items: "{{groups['mysql']}}"

- name: "Stop slave."
  mysql_replication:
    mode: stopslave
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_host: "{{hostvars[inventory_hostname]['ansible_ssh_host']}}"
    login_unix_socket: "/data/mysql/run/mysql.sock"

- name: "Configure replication on the slave."
  mysql_replication:
    mode: changemaster
    master_host: "{{ mysql_replication_master }}"
    master_user: "{{ mysql_replication_name }}"
    master_password: "{{ mysql_replication_passwd }}"
    master_auto_position: yes
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_host: "{{hostvars[inventory_hostname]['ansible_ssh_host']}}"
    login_unix_socket: "/data/mysql/run/mysql.sock"

# mysql -urepl -pMySQLP@ssword4repl -e "show master status\G;"
# mysql -urepl -pMySQLP@ssword4repl -e "show slave status\G;"
- name: Start replication.
  shell: >
    mysql -h{{mysql_replication_master}} -uroot -p'{{ mysql_root_password }}' -e "start slave;" && sleep 3

- name: Exec 'show slave status' for slave
  shell: >
    mysql -h{{mysql_replication_master}} -uroot -p'{{ mysql_root_password }}' -e "show slave status \G;" | grep _Running
  register: slave_status

- name: Show 'show slave status' for slave
  debug:
    msg: "{{slave_status}}"